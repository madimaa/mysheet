version: 2.1

jobs:
  lint-backend:
    docker:
      - image: golang:1.20.2-alpine3.17
    steps:
      - checkout
      - run:
          name: get linter
          command: |
            cd /
            wget -O- -nv https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s 
            golangci-lint --version
      - run:
          name: lint backend
          command: |
            cd backend
            golangci-lint run

  build-backend-image:
    docker:
      - image: cimg/base:2021.04
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.14
          docker_layer_caching: true
      - run:
          name: build image
          command: |
            TAG=madima/mysheet:${CIRCLE_WORKFLOW_ID:0:7}
            docker build -t $TAG -f .circleci/Dockerfile_backend .
            echo "$DOCKER_PASS" | docker login --username $DOCKER_USER --password-stdin
            docker push $TAG
            docker logout

workflows:
  default:
    jobs:
      - lint-backend
      - build-backend-image:
          requires: [lint-backend]
